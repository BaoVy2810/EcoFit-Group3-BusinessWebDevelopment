<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Blog Management - Admin Dashboard</title>
  <link rel="icon" href="../images/ecofit_logo3.png" sizes="32x32" type="image/png">
  <link rel="stylesheet" href="style.css" />
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <script src="./dataManager.js"></script>
  <script src="./script.js"></script>
      <script>
      document.addEventListener("DOMContentLoaded", () => {
        toggleSidebar();
      });
    </script>
  
</head>

<body>
  <div class="dashboard-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div style="display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; padding: 20px 0;">
        <div class="logo"><img src="../images/EcoFit_logo_white.png" width="30" /></div>
        <div>
          <h1 style="font-size: 28px; margin: 0;">Eco<span style="color: #3DA547">Fit</span></h1>
          <p style="margin: 0; font-size: 16px;">Admin Panel</p>
        </div>
      </div>

      <nav class="nav-menu">
        <button class="menu-item" onclick="location.href='dashboard.html'">
          <i data-lucide="bar-chart-3"></i><span>Dashboard</span>
        </button>
        <button class="menu-item" onclick="location.href='accounts.html'">
          <i data-lucide="square-user-round"></i><span>Accounts</span>
        </button>
        <button class="menu-item" onclick="location.href='products.html'">
          <i data-lucide="package"></i><span>Products</span>
        </button>
        <button class="menu-item" onclick="location.href='orders.html'">
          <i data-lucide="list"></i><span>Order Lists</span>
        </button>

        <div class="pages-divider"><p>PAGES</p></div>

        <button class="menu-item" onclick="location.href='promotions.html'">
          <i data-lucide="gift"></i><span>Promotions</span>
        </button>
        <button class="menu-item active"><i data-lucide="calendar"></i><span>Blogs</span></button>
        <button class="menu-item" onclick="location.href='to-do.html'"><i data-lucide="check-square"></i><span>To-Do</span></button>
      </nav>
    </aside>

    <!-- Main Content -->
    <div class="main-content">
      <header class="header">
        <div class="header-left">
          <button class="menu-toggle"><i data-lucide="menu"></i></button>
        </div>

        <div class="header-right">
          <button class="notification-btn">
            <i data-lucide="bell"></i><span class="notification-dot"></span>
          </button>
          <button class="logout-btn" onclick="handleLogout()">
            <i data-lucide="log-out"></i>
          </button>
          <div class="user-profile">
            <div class="user-info">
              <p class="user-name"></p>
              <p class="user-role">Administrator</p>
            </div>
            <img src="../images/admin.png" alt="Admin" />
          </div>
        </div>
      </header>

      <!-- Blog Management -->
      <main class="content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
          <h2 class="page-title" style="margin-bottom: 0;">Blog Management</h2>
        </div>

        <!-- Stats -->
        <div class="stats-grid" style="margin-bottom: 32px;">
          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-info">
                <p class="stat-label">Total Blogs</p>
                <h3 class="stat-value" id="total-blogs">--</h3>
              </div>
              <div class="stat-icon blue-icon"><i data-lucide="file-text"></i></div>
            </div>
            <div class="stat-growth positive">
              <i data-lucide="trending-up"></i>
              <span class="growth-value">15.3%</span>
              <span class="growth-text"> content published</span>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-info">
                <p class="stat-label">Published</p>
                <h3 class="stat-value" id="published-blogs">--</h3>
              </div>
              <div class="stat-icon green-icon"><i data-lucide="check-circle"></i></div>
            </div>
            <div class="stat-growth positive">
              <i data-lucide="trending-up"></i>
              <span class="growth-value">9.2%</span>
              <span class="growth-text"> live articles</span>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-info">
                <p class="stat-label">This Month</p>
                <h3 class="stat-value" id="monthly-blogs">--</h3>
              </div>
              <div class="stat-icon yellow-icon"><i data-lucide="calendar"></i></div>
            </div>
            <div class="stat-growth">
              <i data-lucide="move-right"></i>
              <span class="growth-value">2</span>
              <span class="growth-text"> new posts</span>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-info">
                <p class="stat-label">Draft</p>
                <h3 class="stat-value" id="draft-blogs">--</h3>
              </div>
              <div class="stat-icon red-icon"><i data-lucide="edit-3"></i></div>
            </div>
            <div class="stat-growth negative">
              <i data-lucide="clock"></i>
              <span class="growth-value">1</span>
              <span class="growth-text"> pending review</span>
            </div>
          </div>
        </div>

        <!-- Table -->
        <div class="chart-container" style="padding: 24px;">
          <h3 style="margin-bottom: 24px; font-size: 20px; font-weight: bold;">All Blog Posts</h3>

          <div style="margin-bottom:24px; display: flex; justify-content: space-between; align-items: center; gap: 12px; margin-top: 14px; flex-wrap: wrap;">
            <div style="flex: 1; display: flex; gap: 12px;">
              <div class="search-box">
                <i data-lucide="search" style="width: 20px; height: 20px;"></i>
                <input id="searchInput" placeholder="Search by title" />
              </div>
              <select id="statusFilter">
                <option value="all">All Status</option>
                <option value="published">Published</option>
                <option value="draft">Draft</option>
              </select>
            </div>

            <button id="addBlogBtn">
              <i data-lucide="plus" style="width: 20px; height: 20px;"></i>Add New Blog
            </button>
          </div>

          <div style="max-height: 500px; overflow-y: auto; overflow-x: auto; border: 1px solid #e5e7eb; border-radius: 8px;">
            <table style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr style="border-bottom: 2px solid #e5e7eb; text-align: left;">
                  <th style="padding: 16px;">ID</th>
                  <th style="padding: 16px;">Title</th>
                  <th style="padding: 16px;">Date</th>
                  <th style="padding: 16px;">Sections</th>
                  <th style="padding: 16px;">Status</th>
                  <th style="padding: 16px;">Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr class="template" style="display: none !important; border-bottom: 1px solid #f3f4f6;">
                  <td style="padding: 16px;" name="id"></td>
                  <td style="padding: 16px; max-width: 300px;">
                    <div style="font-weight: 600; color: #111827; margin-bottom: 4px;" name="title"></div>
                    <div style="font-size: 12px; color: #6b7280; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" name="preview"></div>
                  </td>
                  <td style="padding: 16px;"><span name="date"></span></td>
                  <td style="padding: 16px;"><span name="sections"></span></td>
                  <td style="padding: 16px;"><span name="status"></span></td>
                  <td>
                    <div class="action-buttons">
                      <button title="View">
                        <i data-lucide="eye" style="width: 24px; height: 24px;"></i>
                      </button>
                      <button title="Edit">
                        <i data-lucide="Edit" style="width: 24px; height: 24px;"></i>
                      </button>
                      <button title="Delete">
                        <i data-lucide="trash-2" style="width: 24px; height: 24px;"></i>
                      </button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- âœ… CUSTOM CONFIRM BOX -->
  <div id="confirmBox" class="confirm-box">
    <div class="confirm-content">
      <div class="confirm-icon">
        <i data-lucide="alert-triangle" style="width: 32px; height: 32px; color: #ef4444"></i>
      </div>
      <h3 class="confirm-title">Confirm Delete</h3>
      <p class="confirm-message" id="confirmMessage">Are you sure you want to delete this blog?</p>
      <div class="confirm-actions">
        <button onclick="closeConfirmBox()" class="confirm-btn btn-outline">Cancel</button>
        <button id="confirmDeleteBtn" class="confirm-btn btn-delete">Delete</button>
      </div>
    </div>
  </div>

  <!-- Modal View Blog -->
  <div id="viewBlogModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
      <div class="modal-header">
        <h3 id="viewBlogTitle">Blog Details</h3>
        <button class="close-modal" onclick="closeViewModal()">
          <i data-lucide="x"></i>
        </button>
      </div>
      <div class="modal-body" id="viewBlogContent" style="max-height: 70vh; overflow-y: auto; align-items: justify;">
        <!-- Content will be injected here -->
      </div>
      <div class="modal-actions">
        <button class="btn-cancel" onclick="closeViewModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Modal Add/Edit Blog -->
  <div id="blogModal" class="modal">
    <div class="modal-content" style="max-width: 900px;">
      <div class="modal-header">
        <h3 id="modalTitle">Add New Blog</h3>
        <button class="close-modal" onclick="closeModal()">
          <i data-lucide="x"></i>
        </button>
      </div>
      <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
        <div class="error-message" id="errorMessage"></div>
        <form id="blogForm">
          <input type="hidden" id="blogId" />
          
          <div class="form-group">
            <label>Title <span class="required">*</span></label>
            <input type="text" id="blogTitle" placeholder="Enter blog title" required />
          </div>

          <div class="form-group">
            <label>Date <span class="required">*</span></label>
            <input type="text" id="blogDate" placeholder="e.g. 1 Jan 2025" required />
          </div>

          <div class="form-group">
            <label>Image URL</label>
            <input type="text" id="blogImage" placeholder="e.g. image.png" />
          </div>

          <div class="form-group">
            <label>Status <span class="required">*</span></label>
            <select id="blogStatus" required>
              <option value="published">Published</option>
              <option value="draft">Draft</option>
            </select>
          </div>

          <div class="form-group full-width">
            <label>Content Sections <span class="required">*</span></label>
            <div id="contentSections" style="display: flex; flex-direction: column; gap: 16px;">
              <!-- Sections will be added here -->
            </div>
            <button type="button" onclick="addContentSection()" style="margin-top: 12px; background: #6b7280;">
              <i data-lucide="plus"></i>Add Section
            </button>
          </div>
        </form>
      </div>
      <div class="modal-actions">
        <button class="btn-cancel" onclick="closeModal()">Cancel</button>
        <button class="btn-save" onclick="saveBlog()">
          <i data-lucide="save"></i>Save Blog
        </button>
      </div>
    </div>
  </div>

  <script> 
let sectionCounter = 0;
let blogs = [];
let blogToDelete = null; // âœ… THÃŠM BIáº¾N LÆ¯U ID BLOG Cáº¦N XÃ“A

// Render icons
function renderIcons() {
  if (window.lucide && typeof lucide.createIcons === "function") {
    lucide.createIcons();
  }
}

// âœ… LOAD Dá»® LIá»†U Tá»ª DATAMANAGER
function loadBlogs() {
  try {
    console.log('ðŸ“‚ Loading blogs from DataManager...');
    
    blogs = window.DataManager.getBlogs();
    
    if (!blogs || blogs.length === 0) {
      console.warn('âš ï¸ No blogs found');
      blogs = [];
    }

    console.log('âœ… Blogs loaded:', blogs.length);
    
    updateStats();
    updateTable(blogs);
  } catch (error) {
    console.error("âŒ Error loading blogs:", error);
  }
}

// Update statistics
function updateStats() {
  const total = blogs.length;
  const published = blogs.filter(b => b.status === "published").length;
  const draft = blogs.filter(b => b.status === "draft").length;
  
  const now = new Date();
  const currentMonth = blogs.filter(blog => {
    const blogDate = new Date(blog.date);
    return blogDate.getMonth() === now.getMonth() && 
           blogDate.getFullYear() === now.getFullYear();
  }).length;

  document.getElementById("total-blogs").textContent = total;
  document.getElementById("published-blogs").textContent = published;
  document.getElementById("monthly-blogs").textContent = currentMonth;
  document.getElementById("draft-blogs").textContent = draft;
}

// Update table
function updateTable(filteredBlogs) {
  renderTable(filteredBlogs, "table tbody", "table tbody tr.template", (row, blog) => {
    row.querySelector('[name="id"]').textContent = `#${blog.id}`;
    row.querySelector('[name="title"]').textContent = blog.title;
    
    const preview = blog.content && blog.content[0] 
      ? (blog.content[0].text || blog.content[0].heading || '').substring(0, 80) + '...'
      : 'No content available';
    row.querySelector('[name="preview"]').textContent = preview;
    
    row.querySelector('[name="date"]').textContent = blog.date;
    
    const sectionsSpan = row.querySelector('[name="sections"]');
    sectionsSpan.textContent = blog.content ? blog.content.length : 0;
    sectionsSpan.style.cssText = `
      padding: 6px 12px;
      background: #f3f4f6;
      color: #374151;
      border-radius: 6px;
      font-weight: 600;
      font-size: 13px;
    `;

    const statusSpan = row.querySelector('[name="status"]');
    statusSpan.textContent = (blog.status || 'published').charAt(0).toUpperCase() + (blog.status || 'published').slice(1);
    
    if ((blog.status || 'published') === "published") {
      statusSpan.style.cssText = `
        padding: 6px 12px;
        background: #f0fdf4;
        color: #22c55e;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
      `;
    } else {
      statusSpan.style.cssText = `
        padding: 6px 12px;
        background: #fef9c3;
        color: #854d0e;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
      `;
    }

    const buttons = row.querySelectorAll('.action-buttons button');
    const viewBtn = buttons[0];
    const editBtn = buttons[1];
    const deleteBtn = buttons[2];
    
    if (viewBtn) viewBtn.onclick = () => viewBlog(blog);
    if (editBtn) editBtn.onclick = () => openEditModal(blog);
    if (deleteBtn) deleteBtn.onclick = () => deleteBlog(blog.id); // âœ… Gá»ŒI HÃ€M Má»šI
  });
  renderIcons();
}

// Filter handler
function handleFilterChange() {
  const searchValue = safeLower(document.getElementById("searchInput").value);
  const statusValue = document.getElementById("statusFilter").value;

  const filtered = blogs.filter((blog) => {
    const matchSearch = 
      searchValue === "" ||
      safeLower(blog.title).includes(searchValue);

    const matchStatus = statusValue === "all" || (blog.status || 'published') === statusValue;

    return matchSearch && matchStatus;
  });

  updateTable(filtered);
}

// View blog details
function viewBlog(blog) {
  document.getElementById("viewBlogTitle").textContent = blog.title;
  
  let contentHtml = `
    <div style="margin-bottom: 16px;">
      <strong>Date:</strong> ${blog.date}<br>
      <strong>Status:</strong> ${(blog.status || 'published').charAt(0).toUpperCase() + (blog.status || 'published').slice(1)}<br>
      <strong>Sections:</strong> ${blog.content ? blog.content.length : 0}
    </div>
    <hr style="margin: 20px 0; border: none; border-top: 1px solid #e5e7eb;">
  `;
  
  if (blog.content && blog.content.length > 0) {
    blog.content.forEach((section, index) => {
      contentHtml += `
        <div style="margin-bottom: 24px;">
          ${section.heading ? `<h4 style="font-size: 18px; font-weight: 600; color: #111827; margin-bottom: 12px;">${section.heading}</h4>` : ''}
          <p style="color: #374151; line-height: 1.6; white-space: pre-wrap; text-align: justify;padding-right: 12px;">${section.text || ''}</p>
        </div>
      `;
    });
  }
  
  document.getElementById("viewBlogContent").innerHTML = contentHtml;
  document.getElementById("viewBlogModal").classList.add("show");
  renderIcons();
}

// Close view modal
function closeViewModal() {
  document.getElementById("viewBlogModal").classList.remove("show");
}

// Add content section
function addContentSection(heading = '', text = '') {
  const container = document.getElementById("contentSections");
  const sectionId = `section-${sectionCounter++}`;
  
  const sectionDiv = document.createElement('div');
  sectionDiv.className = 'content-section';
  sectionDiv.id = sectionId;
  sectionDiv.style.cssText = 'padding: 16px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;';
  
  sectionDiv.innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
      <strong style="color: #111827;">Section ${sectionCounter}</strong>
      <button type="button" onclick="removeSection('${sectionId}')" style="padding: 4px 8px; background: #ef4444; font-size: 12px; border: none; background: linear-gradient(135deg, #ef4444, #dc2626); color: white;">
        <i data-lucide="x"></i>Remove
      </button>
    </div>
    <div class="form-group" style="margin-bottom: 12px;">
      <label>Heading (optional)</label>
      <input type="text" class="section-heading" placeholder="Section heading" value="${heading}" />
    </div>
    <div class="form-group">
      <label>Text <span class="required">*</span></label>
      <textarea class="section-text" placeholder="Section content" rows="4" required>${text}</textarea>
    </div>
  `;
  
  container.appendChild(sectionDiv);
  renderIcons();
}

// Remove section
function removeSection(sectionId) {
  const section = document.getElementById(sectionId);
  if (section) section.remove();
}

// Open modal for adding
function openAddModal() {
  document.getElementById("modalTitle").textContent = "Add New Blog";
  document.getElementById("blogForm").reset();
  document.getElementById("blogId").value = "";
  document.getElementById("contentSections").innerHTML = "";
  sectionCounter = 0;
  addContentSection();
  document.getElementById("errorMessage").classList.remove("show");
  document.getElementById("blogModal").classList.add("show");
  renderIcons();
}

// Open modal for editing
function openEditModal(blog) {
  document.getElementById("modalTitle").textContent = "Edit Blog";
  document.getElementById("blogId").value = blog.id;
  document.getElementById("blogTitle").value = blog.title;
  document.getElementById("blogDate").value = blog.date;
  document.getElementById("blogImage").value = blog.image || '';
  document.getElementById("blogStatus").value = blog.status || 'published';
  
  document.getElementById("contentSections").innerHTML = "";
  sectionCounter = 0;
  if (blog.content && blog.content.length > 0) {
    blog.content.forEach(section => {
      addContentSection(section.heading || '', section.text || '');
    });
  } else {
    addContentSection();
  }
  
  document.getElementById("errorMessage").classList.remove("show");
  document.getElementById("blogModal").classList.add("show");
  renderIcons();
}

// Close modal
function closeModal() {
  document.getElementById("blogModal").classList.remove("show");
}

// âœ… SAVE BLOG
function saveBlog() {
  const id = document.getElementById("blogId").value;
  const title = document.getElementById("blogTitle").value.trim();
  const date = document.getElementById("blogDate").value.trim();
  const image = document.getElementById("blogImage").value.trim();
  const status = document.getElementById("blogStatus").value;

  if (!title || !date) {
    showError("Please fill in all required fields!");
    return;
  }

  const sections = [];
  const sectionElements = document.querySelectorAll('.content-section');
  sectionElements.forEach(section => {
    const heading = section.querySelector('.section-heading').value.trim();
    const text = section.querySelector('.section-text').value.trim();
    if (text) {
      const sectionObj = { text };
      if (heading) sectionObj.heading = heading;
      sections.push(sectionObj);
    }
  });

  if (sections.length === 0) {
    showError("Please add at least one content section!");
    return;
  }

  try {
    console.log('ðŸ’¾ Saving blog...');
    
    let blogsData = window.DataManager.getBlogs() || [];
    
    if (id) {
      const index = blogsData.findIndex(b => b.id === parseInt(id));
      if (index !== -1) {
        blogsData[index] = {
          ...blogsData[index],
          title,
          date,
          image: image || blogsData[index].image,
          status,
          content: sections
        };
      }
    } else {
      const newId = blogsData.length > 0 ? Math.max(...blogsData.map(b => b.id)) + 1 : 1;
      blogsData.push({
        id: newId,
        title,
        date,
        image: image || "36d4873da38afe804bb9f98407500327ca28985b.png",
        status,
        content: sections
      });
    }

    window.DataManager.saveBlogs(blogsData);
    
    closeModal();
    loadBlogs();
    showToast(id ? "Blog updated successfully!" : "Blog added successfully!", "success");
    
    console.log('âœ… Blog saved successfully');
  } catch (error) {
    console.error("âŒ Error saving blog:", error);
    showError("Failed to save blog!");
  }
}

// âœ… DELETE BLOG - HIá»‚N THá»Š CONFIRM BOX
function deleteBlog(blogId) {
  blogToDelete = blogId;
  const blog = blogs.find((b) => b.id === blogId);

  document.getElementById("confirmMessage").textContent = 
    `Are you sure you want to delete "${blog?.title}"?`;

  document.getElementById("confirmBox").style.display = "flex";
  renderIcons();
}

// âœ… XÃC NHáº¬N XÃ“A BLOG
document.getElementById("confirmDeleteBtn").onclick = function() {
  if (blogToDelete !== null) {
    try {
      console.log('ðŸ—‘ï¸ Deleting blog...', blogToDelete);

      let blogsData = window.DataManager.getBlogs() || [];
      blogsData = blogsData.filter(b => b.id !== blogToDelete);
      window.DataManager.saveBlogs(blogsData);

      closeConfirmBox();
      loadBlogs();
      showToast("Blog deleted successfully!", "success");

      console.log('âœ… Blog deleted successfully');
    } catch (error) {
      console.error("âŒ Error deleting blog:", error);
      showError("Failed to delete blog!");
    } finally {
      blogToDelete = null;
    }
  }
};
// âœ… ÄÃ“NG CONFIRM BOX
function closeConfirmBox() {
  document.getElementById("confirmBox").style.display = "none";
}

      function showToast(message, type = "success") {
  const toast = document.createElement("div");
  const bgColor = type === "success" ? "#22c55e" : "#ef4444";

  toast.style.cssText = `
    position: fixed;
    top: 80px; 
    right: 24px;
    background: ${bgColor};
    color: white;
    padding: 16px 24px;
    border-radius: 12px;
    font-weight: 600;
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    z-index: 10000;
    animation: slideIn 0.3s ease;
  `;
  toast.textContent = message;

  document.body.appendChild(toast);

  setTimeout(() => {
    toast.style.animation = "slideOut 0.3s ease";
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}


// Show error message
function showError(message) {
  const errorEl = document.getElementById("errorMessage");
  errorEl.textContent = message;
  errorEl.classList.add("show");
  setTimeout(() => errorEl.classList.remove("show"), 3000);
}

// âœ… EVENT LISTENERS
document.getElementById("searchInput").addEventListener("input", handleFilterChange);
document.getElementById("statusFilter").addEventListener("change", handleFilterChange);
document.getElementById("addBlogBtn").addEventListener("click", openAddModal);

// Close modals on outside click
document.getElementById("blogModal").addEventListener("click", (e) => {
  if (e.target.id === "blogModal") closeModal();
});
document.getElementById("viewBlogModal").addEventListener("click", (e) => {
  if (e.target.id === "viewBlogModal") closeViewModal();
});

// âœ… INITIALIZATION
window.addEventListener("DOMContentLoaded", () => {
  console.log('ðŸš€ Initializing blogs page...');
  
  loadBlogs();
  renderIcons();
  checkAuthentication();
  console.log('âœ… Blogs page initialized');
});
  </script>
</body>
</html>