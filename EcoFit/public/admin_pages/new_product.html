<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Add New Product - Admin Dashboard</title>
  <link rel="icon" href="../images/ecofit_logo3.png" sizes="32x32" type="image/png">
  <link rel="stylesheet" href="style.css" />
  <script src="https://unpkg.com/lucide@latest"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
</head>

<body style="background: #f9fafb;">
  <div class="form-container">
    <div class="form-card">
      <div class="form-header">
        <button class="back-btn" onclick="goBack()">
          <i data-lucide="arrow-left" style="width: 20px; height: 20px;"></i>
        </button>
        <h2>Add New Product</h2>
      </div>

      <div class="error-message" id="errorMessage"></div>
      <div class="success-message" id="successMessage"></div>

      <form id="addProductForm">
        <div class="form-grid">
          <div class="form-group">
            <label for="product_name">Product Name<span class="required">*</span></label>
            <input type="text" id="product_name" name="product_name" required placeholder="Enter product name" />
          </div>

          <div class="form-group">
            <label for="category_id">Category<span class="required">*</span></label>
            <select id="category_id" name="category_id" required>
              <option value="">Select category</option>
            </select>
          </div>

          <div class="form-group">
            <label for="price">Price (VND)<span class="required">*</span></label>
            <input type="number" id="price" name="price" required placeholder="Enter price" min="0" step="1000" />
          </div>

          <div class="form-group">
            <label for="quantity_available">Quantity Available<span class="required">*</span></label>
            <input type="number" id="quantity_available" name="quantity_available" required placeholder="Enter quantity"
              min="0" />
          </div>

          <div class="form-group">
            <label for="green_score">Green Score (0-100)<span class="required">*</span></label>
            <input type="number" id="green_score" name="green_score" required placeholder="Enter green score" min="0"
              max="100" />
          </div>

          <div class="form-group">
            <label for="material">Material</label>
            <input type="text" id="material" name="material" placeholder="e.g., Organic Cotton, Recycled Polyester" />
          </div>

          <div class="form-group full-width">
            <label for="description">Description<span class="required">*</span></label>
            <textarea id="description" name="description" required placeholder="Enter product description"></textarea>
          </div>

          <div class="form-group full-width">
            <label for="image_upload">Product Images</label>
            <input type="file" id="image_upload" name="image_upload" accept="image/*" multiple
              style="padding: 10px; border: 2px dashed #e5e7eb; border-radius: 8px; cursor: pointer;" />
            <small style="color: #6b7280; font-size: 12px; display: block; margin-top: 8px;">
              You can select multiple images for this product
            </small>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="goBack()">
              <i data-lucide="x" style="width: 18px; height: 18px;"></i>
              Cancel
            </button>
            <button type="submit" class="button">
              <i data-lucide="check" style="width: 18px; height: 18px;"></i>
              Save Product
            </button>
          </div>
      </form>
    </div>
  </div>

  <script>
    lucide.createIcons();

    // ðŸ”¹ HÃ m láº¥y dá»¯ liá»‡u tá»« localStorage
    function getLocalData() {
      const storedData = localStorage.getItem('products');
      if (storedData) {
        return JSON.parse(storedData);
      } else {
        // Náº¿u chÆ°a cÃ³ dá»¯ liá»‡u thÃ¬ táº¡o cáº¥u trÃºc rá»—ng
        const defaultData = { product: [], category: [] };
        localStorage.setItem('products', JSON.stringify(defaultData));
        return defaultData;
      }
    }

    // ðŸ”¹ Táº£i danh má»¥c vÃ o dropdown
    function loadCategories() {
      const data = getLocalData();
      const categorySelect = document.getElementById('category_id');
      categorySelect.innerHTML = '<option value="">Select category</option>';

      data.category.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.category_id;
        option.textContent = cat.category_name;
        categorySelect.appendChild(option);
      });
    }

    // ðŸ”¹ Sinh ID sáº£n pháº©m má»›i dá»±a trÃªn danh sÃ¡ch hiá»‡n cÃ³
    function generateNewProductId() {
      const data = getLocalData();
      const products = data.product;
      if (products.length === 0) return "P001";

      const maxNum = Math.max(
        ...products.map(p => parseInt(p.product_id.replace(/\D/g, '')) || 0)
      );
      return `P${String(maxNum + 1).padStart(3, '0')}`;
    }

    // ðŸ”¹ Quay láº¡i trang chÃ­nh
    function goBack() {
      window.location.href = 'products.html';
    }

    // ðŸ”¹ Hiá»ƒn thá»‹ thÃ´ng bÃ¡o
    function showError(msg) {
      const el = document.getElementById('errorMessage');
      el.textContent = msg;
      el.classList.add('show');
      setTimeout(() => el.classList.remove('show'), 3000);
    }

    function showSuccess(msg) {
      const el = document.getElementById('successMessage');
      el.textContent = msg;
      el.classList.add('show');
      setTimeout(() => {
        el.classList.remove('show');
        goBack();
      }, 1500);
    }

    // ðŸ”¹ Xá»­ lÃ½ khi thÃªm sáº£n pháº©m má»›i
    document.getElementById('addProductForm').addEventListener('submit', (e) => {
      e.preventDefault();

      const formData = new FormData(e.target);
      const price = parseFloat(formData.get('price'));
      const quantity = parseInt(formData.get('quantity_available'));
      const greenScore = parseInt(formData.get('green_score'));

      // Validate
      if (price <= 0) return showError('Price must be greater than 0');
      if (quantity < 0) return showError('Quantity cannot be negative');
      if (greenScore < 0 || greenScore > 100)
        return showError('Green score must be between 0 and 100');

      // Láº¥y dá»¯ liá»‡u hiá»‡n táº¡i
      const data = getLocalData();
      const products = data.product;

      const newId = generateNewProductId();

      // LÆ°u danh sÃ¡ch áº£nh
      const imageFiles = document.getElementById('image_upload').files;
      const imageNames = Array.from(imageFiles).map(file => file.name);

      const newProduct = {
        product_id: newId,
        product_name: formData.get('product_name'),
        description: formData.get('description'),
        price_original: price,
        price: price,
        category_id: formData.get('category_id'),
        quantity_available: quantity,
        green_score: {
          value: greenScore,
          breakdown: {}
        },
        material: formData.get('material') || "",
        product_images: imageNames
      };

      // Cáº­p nháº­t localStorage
      products.push(newProduct);
      localStorage.setItem('products', JSON.stringify({
        product: products,
        category: data.category
      }));

      console.log('âœ… Product added:', newProduct);
      showSuccess('Product created successfully!');
    });

    // ðŸ”¹ Khi trang load, táº£i danh má»¥c
    document.addEventListener('DOMContentLoaded', loadCategories);
  </script>

</body>

</html>