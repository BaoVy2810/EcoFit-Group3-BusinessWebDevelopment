<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Edit Product - Admin Dashboard</title>
  <link rel="icon" href="../images/ecofit_logo3.png" sizes="32x32" type="image/png">
  <link rel="stylesheet" href="style.css" />
  <script src="https://unpkg.com/lucide@latest"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    .image-slider {
      position: relative;
      width: 100%;
      max-width: 500px;
      margin: 20px auto;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .slider-container {
      position: relative;
      width: 100%;
      height: 400px;
      background: #f3f4f6;
    }

    .slider-image {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: none;
    }

    .slider-image.active {
      display: block;
    }

    .slider-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255, 255, 255, 0.9);
      border: none;
      padding: 12px;
      cursor: pointer;
      border-radius: 50%;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      transition: all 0.2s;
      z-index: 10;
    }

    .slider-nav:hover {
      background: white;
      transform: translateY(-50%) scale(1.1);
    }

    .slider-nav.prev {
      left: 10px;
    }

    .slider-nav.next {
      right: 10px;
    }

    .slider-dots {
      position: absolute;
      bottom: 15px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      z-index: 10;
    }

    .slider-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.6);
      border: none;
      cursor: pointer;
      transition: all 0.2s;
    }

    .slider-dot.active {
      background: white;
      width: 24px;
      border-radius: 5px;
    }

    .image-counter {
      position: absolute;
      top: 15px;
      right: 15px;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      z-index: 10;
    }

    .no-images {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #9ca3af;
      font-size: 14px;
    }
  </style>
</head>

<body style="background: #f9fafb;">
  <div class="form-container">
    <div class="form-card">
      <div class="form-header">
        <button class="back-btn" onclick="goBack()">
          <i data-lucide="arrow-left" style="width: 20px; height: 20px;"></i>
        </button>
        <h2>Edit Product</h2>
      </div>

      <div class="error-message" id="errorMessage"></div>
      <div class="success-message" id="successMessage"></div>

      <!-- Image Slider -->
      <div id="imageSliderContainer" style="display: none;">
        <h3 style="margin-bottom: 16px; font-size: 18px; font-weight: 600; color: #111827;">Product Images</h3>
        <div class="image-slider">
          <div class="slider-container">
            <div id="imageSlider"></div>
            <div class="image-counter" id="imageCounter"></div>
            <button class="slider-nav prev" id="prevBtn" style="display: none;">
              <i data-lucide="chevron-left" style="width: 20px; height: 20px;"></i>
            </button>
            <button class="slider-nav next" id="nextBtn" style="display: none;">
              <i data-lucide="chevron-right" style="width: 20px; height: 20px;"></i>
            </button>
            <div class="slider-dots" id="sliderDots"></div>
          </div>
        </div>
      </div>

      <form id="editProductForm">
        <div class="form-grid">
          <div class="form-group">
            <label for="product_name">Product Name<span class="required">*</span></label>
            <input type="text" id="product_name" name="product_name" required placeholder="Enter product name" />
          </div>

          <div class="form-group">
            <label for="category_id">Category<span class="required">*</span></label>
            <select id="category_id" name="category_id" required>
              <option value="">Select category</option>
            </select>
          </div>

          <div class="form-group">
            <label for="price">Price (VND)<span class="required">*</span></label>
            <input type="number" id="price" name="price" required placeholder="Enter price" min="0" step="1000" />
          </div>

          <div class="form-group">
            <label for="quantity_available">Quantity Available<span class="required">*</span></label>
            <input type="number" id="quantity_available" name="quantity_available" required placeholder="Enter quantity" min="0" />
          </div>

          <div class="form-group">
            <label for="green_score">Green Score (0-100)<span class="required">*</span></label>
            <input type="number" id="green_score" name="green_score" required placeholder="Enter green score" min="0" max="100" />
          </div>

          <div class="form-group">
            <label for="material">Material</label>
            <input type="text" id="material" name="material" placeholder="e.g., Organic Cotton, Recycled Polyester" />
          </div>

          <div class="form-group full-width">
            <label for="description">Description<span class="required">*</span></label>
            <textarea id="description" name="description" required placeholder="Enter product description"></textarea>
          </div>

          <div class="form-group full-width">
            <label for="image_upload">Update Product Images</label>
            <input type="file" id="image_upload" name="image_upload" accept="image/*" multiple 
                   style="padding: 10px; border: 2px dashed #e5e7eb; border-radius: 8px; cursor: pointer;" />
            <small style="color: #6b7280; font-size: 12px; display: block; margin-top: 8px;">
              Upload new images to replace current ones (optional)
            </small>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="goBack()">
            <i data-lucide="x" style="width: 18px; height: 18px;"></i>
            Cancel
          </button>
          <button type="submit" class="btn btn-primary">
            <i data-lucide="check" style="width: 18px; height: 18px;"></i>
            Update Product
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    lucide.createIcons();

    let categories = [];
    let currentProduct = null;
    let productId = null;
    let currentImageIndex = 0;
    let productImages = [];

    function goBack() {
      window.location.href = 'products.html';
    }

    function showError(message) {
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.textContent = message;
      errorDiv.classList.add('show');
      setTimeout(() => {
        errorDiv.classList.remove('show');
      }, 5000);
    }

    function showSuccess(message) {
      const successDiv = document.getElementById('successMessage');
      successDiv.textContent = message;
      successDiv.classList.add('show');
      setTimeout(() => {
        successDiv.classList.remove('show');
        goBack();
      }, 2000);
    }

    function initializeImageSlider(images) {
      console.log('Initializing slider with images:', images);
      
      if (!images || images.length === 0) {
        document.getElementById('imageSliderContainer').style.display = 'none';
        return;
      }

      document.getElementById('imageSliderContainer').style.display = 'block';
      productImages = images;
      currentImageIndex = 0;

      const sliderContainer = document.getElementById('imageSlider');
      const dotsContainer = document.getElementById('sliderDots');
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const imageCounter = document.getElementById('imageCounter');

      // Clear previous content
      sliderContainer.innerHTML = '';
      dotsContainer.innerHTML = '';

      // Show/hide navigation buttons
      if (images.length === 1) {
        prevBtn.style.display = 'none';
        nextBtn.style.display = 'none';
        dotsContainer.style.display = 'none';
      } else {
        prevBtn.style.display = 'block';
        nextBtn.style.display = 'block';
        dotsContainer.style.display = 'flex';
      }

      // Show counter
      imageCounter.textContent = `1 / ${images.length}`;

      images.forEach((imageName, index) => {
        const img = document.createElement('img');
        // Đường dẫn từ public/admin_pages/ lên dataset/product_images/
        img.src = `../../dataset/product_images/${imageName}`;
        img.alt = `Product image ${index + 1}`;
        img.className = 'slider-image';
        if (index === 0) img.classList.add('active');
        
        img.onerror = function() {
          console.error(`Failed to load image: ${imageName}`);
          console.log(`Tried path: ../../dataset/product_images/${imageName}`);
          this.style.display = 'none';
          if (index === 0) {
            const noImageDiv = document.createElement('div');
            noImageDiv.className = 'no-images';
            noImageDiv.innerHTML = `<div style="text-align: center;">
              <i data-lucide="image-off" style="width: 48px; height: 48px; margin-bottom: 8px;"></i>
              <div>Image not found: ${imageName}</div>
            </div>`;
            sliderContainer.appendChild(noImageDiv);
            if (typeof lucide !== 'undefined') lucide.createIcons();
          }
        };
        
        img.onload = function() {
          console.log(`Successfully loaded image: ${imageName}`);
        };
        
        sliderContainer.appendChild(img);

        const dot = document.createElement('button');
        dot.className = 'slider-dot';
        if (index === 0) dot.classList.add('active');
        dot.onclick = () => showImage(index);
        dotsContainer.appendChild(dot);
      });

      updateCounter();

      prevBtn.onclick = () => showImage(currentImageIndex - 1);
      nextBtn.onclick = () => showImage(currentImageIndex + 1);

      lucide.createIcons();
    }

    function showImage(index) {
      if (index < 0) index = productImages.length - 1;
      if (index >= productImages.length) index = 0;

      const images = document.querySelectorAll('.slider-image');
      const dots = document.querySelectorAll('.slider-dot');

      images[currentImageIndex]?.classList.remove('active');
      dots[currentImageIndex]?.classList.remove('active');

      currentImageIndex = index;

      images[currentImageIndex]?.classList.add('active');
      dots[currentImageIndex]?.classList.add('active');

      updateCounter();
    }

    function updateCounter() {
      const counter = document.getElementById('imageCounter');
      counter.textContent = `${currentImageIndex + 1} / ${productImages.length}`;
    }

    async function loadCategories() {
      try {
        const storedData = localStorage.getItem('products');
        if (storedData) {
          const data = JSON.parse(storedData);
          categories = data.category;
        } else {
          const response = await fetch('../../dataset/products.json');
          const data = await response.json();
          categories = data.category;
        }

        const categorySelect = document.getElementById('category_id');
        categories.forEach(cat => {
          const option = document.createElement('option');
          option.value = cat.category_id;
          option.textContent = cat.category_name;
          categorySelect.appendChild(option);
        });
      } catch (error) {
        console.error('Error loading categories:', error);
      }
    }

    async function loadProductData() {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        productId = urlParams.get('id');

        if (!productId) {
          showError('Product ID not found');
          setTimeout(goBack, 2000);
          return;
        }

        const storedData = localStorage.getItem('products');
        let data;

        if (storedData) {
          data = JSON.parse(storedData);
        } else {
          const response = await fetch('../../dataset/products.json');
          data = await response.json();
        }

        const products = data.product;
        currentProduct = products.find(p => p.product_id === productId);

        if (!currentProduct) {
          showError('Product not found');
          setTimeout(goBack, 2000);
          return;
        }

        document.getElementById('product_name').value = currentProduct.product_name || '';
        document.getElementById('category_id').value = currentProduct.category_id || '';
        document.getElementById('price').value = currentProduct.price_original || currentProduct.price || '';
        document.getElementById('quantity_available').value = currentProduct.quantity_available || '';
        
        const greenScore = currentProduct.green_score?.value || currentProduct.green_score || '';
        document.getElementById('green_score').value = greenScore;
        
        document.getElementById('material').value = currentProduct.material || '';
        document.getElementById('description').value = currentProduct.description || '';

        if (currentProduct.product_images && currentProduct.product_images.length > 0) {
          initializeImageSlider(currentProduct.product_images);
        }

      } catch (error) {
        console.error('Error loading product:', error);
        showError('Failed to load product data');
      }
    }

    document.getElementById('editProductForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(e.target);
      const price = parseFloat(formData.get('price'));
      const quantity = parseInt(formData.get('quantity_available'));
      const greenScore = parseInt(formData.get('green_score'));

      if (price <= 0) {
        showError('Price must be greater than 0');
        return;
      }

      if (quantity < 0) {
        showError('Quantity cannot be negative');
        return;
      }

      if (greenScore < 0 || greenScore > 100) {
        showError('Green score must be between 0 and 100');
        return;
      }

      try {
        const storedData = localStorage.getItem('products');
        let data;

        if (storedData) {
          data = JSON.parse(storedData);
        } else {
          const response = await fetch('../../dataset/products.json');
          data = await response.json();
        }

        const products = data.product;
        const productIndex = products.findIndex(p => p.product_id === productId);

        if (productIndex === -1) {
          showError('Product not found');
          return;
        }

        const imageFiles = document.getElementById('image_upload').files;
        let updatedImages = currentProduct.product_images || [];

        if (imageFiles.length > 0) {
          updatedImages = Array.from(imageFiles).map(file => file.name);
          console.log('New images selected:', updatedImages);
        }

        const updatedProduct = {
          ...products[productIndex],
          product_name: formData.get('product_name'),
          description: formData.get('description'),
          price_original: price,
          price: price,
          category_id: formData.get('category_id'),
          quantity_available: quantity,
          green_score: {
            value: greenScore,
            breakdown: products[productIndex].green_score?.breakdown || {}
          },
          material: formData.get('material') || "",
          product_images: updatedImages
        };

        products[productIndex] = updatedProduct;

        const updatedData = {
          product: products,
          category: data.category
        };

        localStorage.setItem('products', JSON.stringify(updatedData));

        console.log('Product updated:', updatedProduct);
        showSuccess('Product updated successfully!');

      } catch (error) {
        console.error('Error updating product:', error);
        showError('Failed to update product. Please try again.');
      }
    });

    document.addEventListener('DOMContentLoaded', async () => {
      await loadCategories();
      await loadProductData();
    });
  </script>
</body>
</html> 