<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Account Management - Admin Dashboard</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://unpkg.com/lucide@latest"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="icon" href="../images/ecofit_logo3.png" sizes="32x32" type="image/png">

  <script src="./dataManager.js"></script>
  <script src="./script.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // Toggle Sidebar
      const menuToggle = document.querySelector('.menu-toggle');
      const sidebar = document.querySelector('.sidebar');
      const mainContent = document.querySelector('.main-content');

      if (menuToggle) {
        menuToggle.addEventListener('click', () => {
          sidebar.classList.toggle('collapsed');
          mainContent.classList.toggle('expanded');
        });
      }

    });
  </script>
</head>

<body>
  <div class="dashboard-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div
        style="display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; padding: 20px 0;">
        <div class="logo"><img src="../images/EcoFit_logo_white.png" width="30" /></div>
        <div>
          <h1 style="font-size: 28px; margin: 0;">Eco<span style="color: #3DA547">Fit</span></h1>
          <p style="margin: 0; font-size: 16px;">Admin Panel</p>
        </div>
      </div>

      <nav class="nav-menu">
        <button class="menu-item" onclick="location.href='dashboard.html'">
          <i data-lucide="bar-chart-3"></i><span>Dashboard</span>
        </button>
        <button class="menu-item active">
          <i data-lucide="square-user-round"></i><span>Accounts</span>
        </button>
        <button class="menu-item" onclick="location.href='products.html'">
          <i data-lucide="package"></i><span>Products</span>
        </button>
        <button class="menu-item" onclick="location.href='orders.html'"><i data-lucide="list"></i>
          <span>Order Lists</span></button>
        <div class="pages-divider">
          <p>PAGES</p>
        </div>

        <button class="menu-item" onclick="location.href='promotions.html'"><i
            data-lucide="gift"></i><span>Promotions</span></button>
        <button class="menu-item" onclick="location.href='blogs.html'"><i
            data-lucide="calendar"></i><span>Blogs</span></button>
        <button class="menu-item" onclick="location.href='to-do.html'"><i
            data-lucide="check-square"></i><span>To-Do</span></button>

      </nav>
    </aside>


    <!-- Main Content -->
    <div class="main-content">
      <header class="header">
        <div class="header-left">
          <button class="menu-toggle"><i data-lucide="menu"></i></button>
        </div>

        <div class="header-right">
          <button class="notification-btn">
            <i data-lucide="bell"></i><span class="notification-dot"></span>
          </button>
          <button class="logout-btn" onclick="handleLogout()">
            <i data-lucide="log-out"></i>
          </button>
          <div class="user-profile">
            <div class="user-info">
              <p class="user-name"></p>
              <p class="user-role">Administrator</p>
            </div>
            <img src="../images/admin.png" alt="Admin" />
          </div>
        </div>
      </header>

      <!-- Account Management -->
      <main class="content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
          <h2 class="page-title" style="margin-bottom: 0;">Account Management</h2>
        </div>

        <!-- Stats -->
        <div class="stats-grid" style="margin-bottom: 32px;">
          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-info">
                <p class="stat-label">Total Accounts</p>
                <h3 class="stat-value" id="total-accounts">--</h3>
              </div>
              <div class="stat-icon blue-icon"><i data-lucide="users"></i></div>
            </div>
            <div class="stat-growth positive">
              <i data-lucide="trending-up"></i>
              <span class="growth-value" id="user-growth">0%</span>
              <span class="growth-text"> from last month</span>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-info">
                <p class="stat-label">Active Users</p>
                <h3 class="stat-value" id="active-users">--</h3>
              </div>
              <div class="stat-icon green-icon"><i data-lucide="user-check"></i></div>
            </div>
            <div class="stat-growth positive">
              <i data-lucide="trending-up"></i>
              <span class="growth-value" id="active-users-growth">0%</span>
              <span class="growth-text"> from last month</span>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-info">
                <p class="stat-label">New This Month</p>
                <h3 class="stat-value" id="new-users">--</h3>
              </div>
              <div class="stat-icon yellow-icon"><i data-lucide="user-plus"></i></div>
            </div>
            <div class="stat-growth positive">
              <i data-lucide="trending-up"></i>
              <span class="growth-value" id="new-users-growth">0%</span>
              <span class="growth-text"> user is customer</span>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-info">
                <p class="stat-label">Inactive</p>
                <h3 class="stat-value" id="inactive-users">--</h3>
              </div>
              <div class="stat-icon red-icon"><i data-lucide="user-x"></i></div>
            </div>
            <div class="stat-growth negative">
              <i data-lucide="trending-down"></i>
              <span class="growth-value" id="inactive-users-growth">0%</span>
              <span class="growth-text"> from last month</span>
            </div>
          </div>
        </div>
        <!-- Table -->
        <div class="chart-container" style="padding: 24px;">
          <h3 style="margin-bottom: 24px; font-size: 20px; font-weight: bold;">All Accounts</h3>

          <div
            style="margin-bottom:24px; display: flex; justify-content: space-between; align-items: center; gap: 12px; margin-top: 14px; flex-wrap: wrap;">
            <div style="flex: 1; display: flex; gap: 12px;">
              <div class="search-box">
                <i data-lucide="search" style="width: 20px; height: 20px;"></i>
                <input id="searchInput" placeholder="Search by name or email" />
              </div>
              <select id="roleFilter">
                <option value="all">All Role</option>
                <option value="administrator">Administrator</option>
                <option value="customer">Customer</option>
              </select>

              <select id="statusFilter">
                <option value="all">All Status</option>
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
              </select>
            </div>

            <button onclick="location.href='new_account.html'">
              <i data-lucide="user-plus" style="width: 20px; height: 20px;"></i>Add New Account
            </button>
          </div>

          <div style="
  max-height: 500px;       
  overflow-y: auto;
  overflow-x: auto;
  border: 1px solid #e5e7eb; 
  border-radius: 8px;
">
            <table style="width: 100%; border-collapse: collapse;">

              <thead>
                <tr style="border-bottom: 2px solid #e5e7eb; text-align: left;">
                  <th>ID</th>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Role</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr class="template" style="display: none !important; border-bottom: 1px solid #f3f4f6;">
                  <td style="padding: 16px;"></td>
                  <td style="padding: 16px;"><span name="name"></span></td>
                  <td style="padding: 16px;" name="email"></td>
                  <td style="padding: 16px;"><span name="role"></span></td>
                  <td style="padding: 16px;"><span name="status"></span></td>
                  <td style="padding: 16px;">
                    <button
                      style="padding: 8px; border: none; background: transparent; cursor: pointer; color: #3b82f6;"
                      onclick="handleEditAccount(this)"
                      data-account-id="">
                      <i data-lucide="edit"></i>
                    </button>
                    <button
                      style="padding: 8px; border: none; background: transparent; cursor: pointer; color: #ef4444;"
                      onclick="handleDeleteAccount(this)"
                      data-account-id="">
                      <i data-lucide="trash-2"></i>
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- CUSTOM CONFIRM BOX -->
  <div id="confirmBox" class="confirm-box">
    <div class="confirm-content">
      <div class="confirm-icon">
        <i data-lucide="alert-triangle" style="width: 32px; height: 32px; color: #ef4444"></i>
      </div>
      <h3 class="confirm-title">Confirm Delete</h3>
      <p class="confirm-message" id="confirmMessage">Are you sure you want to delete this account?</p>
      <div class="confirm-actions">
        <button onclick="closeConfirmBox()" class="confirm-btn btn-outline">Cancel</button>
        <button id="confirmDeleteBtn" class="confirm-btn btn-delete">Delete</button>
      </div>
    </div>
  </div>

  <!-- EDIT ACCOUNT MODAL -->
  <div id="editAccountModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Edit Account Information</h3>
        <button onclick="closeEditModal()">
          <i data-lucide="x" style="width: 24px; height: 24px"></i>
        </button>
      </div>

      <form id="editAccountForm" class="modal-form">
        <input type="hidden" id="edit_account_id" />

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px">
          <div>
            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Full Name</label>
            <input type="text" id="edit_fullname" required />
          </div>

          <div>
            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Email</label>
            <input type="email" id="edit_email" required />
          </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px">
          <div>
            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Role</label>
            <select id="edit_role" required>
              <option value="customer">Customer</option>
              <option value="administrator">Administrator</option>
            </select>
          </div>

          <div>
            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Status</label>
            <select id="edit_status" required>
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
            </select>
          </div>
        </div>

        <div class="modal-actions">
          <button type="button" onclick="closeEditModal()" class="modal-cancel-button">Cancel</button>
          <button type="submit" class="modal-button">
            Save Changes
            <i data-lucide="check" style="width: 16px; height: 16px;"></i>
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let accounts = [];
    let accountToDelete = null;

    // âœ… Xá»¬ LÃ EDIT ACCOUNT
    function handleEditAccount(button) {
      const accountId = button.getAttribute('data-account-id');
      if (accountId) {
        editAccount(accountId);
      }
    }

    function editAccount(accountId) {
      const account = accounts.find(acc => (acc.id || acc.profile_id) === accountId);
      if (!account) return;

      document.getElementById("edit_account_id").value = accountId;
      document.getElementById("edit_fullname").value = account.fullname;
      document.getElementById("edit_email").value = account.email;
      document.getElementById("edit_role").value = account.role;
      document.getElementById("edit_status").value = account.status;

      document.getElementById("editAccountModal").style.display = "flex";
      if (typeof lucide !== "undefined") lucide.createIcons();
    }

    function closeEditModal() {
      document.getElementById("editAccountModal").style.display = "none";
      document.getElementById("editAccountForm").reset();
    }

    document.getElementById("editAccountForm").onsubmit = function (e) {
      e.preventDefault();

      const accountId = document.getElementById("edit_account_id").value;
      const accountIndex = accounts.findIndex(acc => (acc.id || acc.profile_id) === accountId);

      if (accountIndex === -1) {
        showToast("Account not found!", "error");
        return;
      }

      console.log("ðŸ’¾ Saving account changes...");

      // Update account information
      accounts[accountIndex] = {
        ...accounts[accountIndex],
        fullname: document.getElementById("edit_fullname").value,
        email: document.getElementById("edit_email").value,
        role: document.getElementById("edit_role").value,
        status: document.getElementById("edit_status").value,
      };

      // Save to DataManager
      let accountsData = window.DataManager.getData('accounts');
      accountsData.profile = accounts;
      window.DataManager.saveData('accounts', accountsData);

      // Update UI
      loadAccountsData();
      handleFilterChange();
      closeEditModal();
      showToast("Account updated successfully!", "success");
      console.log("âœ… Account updated successfully");
    };

    // âœ… Xá»¬ LÃ DELETE ACCOUNT
    function handleDeleteAccount(button) {
      const accountId = button.getAttribute('data-account-id');
      if (accountId) {
        deleteAccount(accountId);
      }
    }

    function deleteAccount(accountId) {
      accountToDelete = accountId;
      const account = accounts.find(acc => (acc.id || acc.profile_id) === accountId);

      document.getElementById("confirmMessage").textContent = 
        `Are you sure you want to delete "${account?.fullname}"?`;

      document.getElementById("confirmBox").style.display = "flex";
      if (typeof lucide !== "undefined") lucide.createIcons();
    }

    document.getElementById("confirmDeleteBtn").onclick = function () {
      if (!accountToDelete) return;

      try {
        console.log("ðŸ—‘ï¸ Deleting account:", accountToDelete);

        // Remove from accounts array
        accounts = accounts.filter(acc => (acc.id || acc.profile_id) !== accountToDelete);

        // Save to DataManager
        let accountsData = window.DataManager.getData('accounts');
        accountsData.profile = accounts;
        window.DataManager.saveData('accounts', accountsData);

        // Update UI
        loadAccountsData();
        handleFilterChange();

        closeConfirmBox();
        showToast("Account deleted successfully!", "success");

        console.log("âœ… Account deleted successfully");
      } catch (error) {
        console.error("âŒ Error deleting account:", error);
        showToast("An error occurred while deleting account!", "error");
      }
    };

    function closeConfirmBox() {
      document.getElementById("confirmBox").style.display = "none";
      accountToDelete = null;
    }

    // Toast notification
    function showToast(message, type = "success") {
      const toast = document.createElement("div");
      const bgColor = type === "success" ? "#22c55e" : "#ef4444";

      toast.style.cssText = `
        position: fixed;
        top: 80px;
        right: 24px;
        background: ${bgColor};
        color: white;
        padding: 16px 24px;
        border-radius: 12px;
        font-weight: 600;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        z-index: 10000;
        animation: slideIn 0.3s ease;
      `;
      toast.textContent = message;

      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = "slideOut 0.3s ease";
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // âœ… INITIALIZATION
    document.addEventListener("DOMContentLoaded", () => {
      console.log('ðŸš€ Initializing accounts page...');

      // Initialize Lucide icons
      if (typeof lucide !== "undefined") {
        lucide.createIcons();
      }

      // Load data
      loadAccounts();
      loadAccountsData();
checkAuthentication();
      // Setup event listeners
      document.getElementById("searchInput").addEventListener("input", handleFilterChange);
      document.getElementById("roleFilter").addEventListener("change", handleFilterChange);
      document.getElementById("statusFilter").addEventListener("change", handleFilterChange);

      document.getElementById("searchInput").addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          handleFilterChange();
        }
      });

      console.log('âœ… Accounts page initialized');
    });

    // âœ… LOAD Dá»® LIá»†U Tá»ª DATAMANAGER
    async function loadAccountsData() {
      try {
        console.log('ðŸ“Š Loading accounts data from DataManager...');

        accounts = window.DataManager.getAccounts();

        if (!accounts || accounts.length === 0) {
          console.warn('âš ï¸ No accounts found');
          return;
        }

        console.log('âœ… Accounts loaded:', accounts.length);

        // TÃ­nh toÃ¡n statistics
        const activeUsers = accounts.filter((a) => a.status === "active");
        const inactiveUsers = accounts.filter((a) => a.status === "inactive");

        const now = new Date();
        const newThisMonth = accounts.filter((acc) => {
          const d = new Date(acc.created_at);
          return (
            d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear()
          );
        }).length;

        // Update UI
        document.getElementById("total-accounts").textContent = accounts.length;
        document.getElementById("active-users").textContent = activeUsers.length;
        document.getElementById("inactive-users").textContent = inactiveUsers.length;
        document.getElementById("new-users").textContent = newThisMonth;

        // Apply growth calculations
        if (typeof applyMonthlyGrowth === "function") {
          applyMonthlyGrowth("user", accounts, "created_at");
          applyMonthlyGrowth("active-users", activeUsers, "created_at");
          applyMonthlyGrowth(
            "new-users",
            accounts.filter((a) => a.role === "customer"),
            "created_at"
          );
          applyMonthlyGrowth("inactive-users", inactiveUsers, "created_at");
        }
      } catch (error) {
        console.error("âŒ Error loading accounts:", error);
      }
    }

    // âœ… LOAD VÃ€ RENDER TABLE
    async function loadAccounts() {
      try {
        console.log('ðŸ“‹ Loading accounts for table...');

        accounts = window.DataManager.getAccounts();

        if (!accounts || accounts.length === 0) {
          console.warn('âš ï¸ No accounts to display');
          return;
        }

        updateTable(accounts);
        console.log('âœ… Accounts table rendered');
      } catch (error) {
        console.error("âŒ Error loading accounts:", error);
      }
    }

    // Render table
    function updateTable(filteredAccounts) {
      renderTable(filteredAccounts, "table tbody", "table tbody tr.template", (row, acc) => {
        const accountId = acc.id || acc.profile_id;
        
        row.querySelector("td:nth-child(1)").textContent = `#${accountId}`;
        row.querySelector('[name="name"]').textContent = acc.fullname;
        row.querySelector('[name="email"]').textContent = acc.email;

        const roleSpan = row.querySelector('[name="role"]');
        roleSpan.textContent = acc.role.charAt(0).toUpperCase() + acc.role.slice(1);

        if (acc.role === "administrator") {
          roleSpan.style.cssText = `
        padding: 6px 16px;
        background: linear-gradient(135deg, #53C15C 0%, #7DE579 100%);
        color: white;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
        letter-spacing: 0.5px;
      `;
        } else {
          roleSpan.style.cssText = `
        padding: 6px 16px;
        background: linear-gradient(135deg, #265BD4 0%, #4880FF 100%);
        color: white;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
        letter-spacing: 0.5px;
      `;
        }

        const statusSpan = row.querySelector('[name="status"]');
        statusSpan.textContent = acc.status.charAt(0).toUpperCase() + acc.status.slice(1);
        statusSpan.style.background = acc.status === "active" ? "#f0fdf4" : "#f3f4f6";
        statusSpan.style.color = acc.status === "active" ? "#22c55e" : "#6b7280";
        statusSpan.style.padding = "4px 12px";
        statusSpan.style.borderRadius = "12px";
        statusSpan.style.fontSize = "12px";
        statusSpan.style.fontWeight = "500";

        // Set account ID cho cÃ¡c button
        const editBtn = row.querySelector('button[onclick*="handleEditAccount"]');
        const deleteBtn = row.querySelector('button[onclick*="handleDeleteAccount"]');
        
        if (editBtn) editBtn.setAttribute('data-account-id', accountId);
        if (deleteBtn) deleteBtn.setAttribute('data-account-id', accountId);
      });
    }

    // Filter handler
    function handleFilterChange() {
      const searchValue = safeLower(document.getElementById("searchInput").value);
      const roleValue = document.getElementById("roleFilter").value;
      const statusValue = document.getElementById("statusFilter").value;

      const filtered = accounts.filter((acc) => {
        const matchSearch =
          searchValue === "" ||
          safeLower(acc.fullname).includes(searchValue) ||
          safeLower(acc.email).includes(searchValue);

        const matchRole = roleValue === "all" || acc.role === roleValue;
        const matchStatus = statusValue === "all" || acc.status === statusValue;

        return matchSearch && matchRole && matchStatus;
      });

      updateTable(filtered);
    }

    // Animation keyframes
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>