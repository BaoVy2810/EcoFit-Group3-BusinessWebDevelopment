<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard</title>
  <link rel="icon" href="../images/ecofit_logo3.png" sizes="32x32" type="image/png">
  <link rel="stylesheet" href="style.css" />
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <!-- Recharts via CDN -->
  <script src="https://cdn.jsdelivr.net/npm/recharts@2.5.0/dist/Recharts.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="icon" href="../images/ecofit_logo3.png" sizes="32x32" type="image/png">

  <script src="./dataManager.js"></script>
  <script src="./script.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // Toggle Sidebar
      const menuToggle = document.querySelector('.menu-toggle');
      const sidebar = document.querySelector('.sidebar');
      const mainContent = document.querySelector('.main-content');

      if (menuToggle) {
        menuToggle.addEventListener('click', () => {
          sidebar.classList.toggle('collapsed');
          mainContent.classList.toggle('expanded');
        });
      }

    });
  </script>
</head>

<body>
  <div class="dashboard-container">
    <aside class="sidebar">
      <div
        style="display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; padding: 20px 0;">
        <div class="logo"><img src="../images/EcoFit_logo_white.png" width="30" /></div>
        <div>
          <h1 style="font-size: 28px; margin: 0;">Eco<span style="color: #3DA547">Fit</span></h1>
          <p style="margin: 0; font-size: 16px;">Admin Panel</p>
        </div>
      </div>

      <nav class="nav-menu">
        <button class="menu-item active" onclick="location.href='dashboard.html' ">
          <i data-lucide="bar-chart-3"></i><span>Dashboard</span>
        </button>
        <button class="menu-item" onclick="location.href='accounts.html'">
          <i data-lucide="square-user-round"></i><span>Accounts</span>
        </button>
        <button class="menu-item" onclick="location.href='products.html'">
          <i data-lucide="package"></i><span>Products</span>
        </button>
        <button class="menu-item" onclick="location.href='orders.html'"><i data-lucide="list"></i><span>Order
            Lists</span></button>

        <div class="pages-divider">
          <p>PAGES</p>
        </div>
        <button class="menu-item" onclick="location.href='promotions.html'"><i
            data-lucide="gift"></i><span>Promotions</span></button>
        <button class="menu-item" onclick="location.href='blogs.html'"><i
            data-lucide="calendar"></i><span>Blogs</span></button>
        <button class="menu-item" onclick="location.href='to-do.html'"><i
            data-lucide="check-square"></i><span>To-Do</span></button>
      </nav>
    </aside>

    <!-- Main Content -->
    <div class="main-content">
      <header class="header">
        <div class="header-left">
          <button class="menu-toggle"><i data-lucide="menu"></i></button>
        </div>

        <div class="header-right">
          <button class="notification-btn">
            <i data-lucide="bell"></i><span class="notification-dot"></span>
          </button>
          <button class="logout-btn" onclick="handleLogout()">
            <i data-lucide="log-out"></i>
          </button>
          <div class="user-profile">
            <div class="user-info">
              <p class="user-name"></p>
              <p class="user-role">Administrator</p>
            </div>
            <img src="../images/admin.png" alt="Admin" />
          </div>
        </div>
      </header>

      <!-- Dashboard Content -->
      <main class="content">
        <h2 class="page-title">Dashboard</h2>

        <!-- Stats Grid -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-info">
                <p class="stat-label">Total User</p>
                <h3 class="stat-value" id="total-user">--</h3>
              </div>
              <div class="stat-icon blue-icon">
                <i data-lucide="users"></i>
              </div>
            </div>
            <div class="stat-growth positive">
              <i data-lucide="trending-up"></i>
              <span class="growth-value" id="user-growth">0%</span>
              <span class="growth-text">Up from yesterday</span>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-info">
                <p class="stat-label">Total Order</p>
                <h3 class="stat-value" id="total-order">--</h3>
              </div>
              <div class="stat-icon yellow-icon">
                <i data-lucide="package"></i>
              </div>
            </div>
            <div class="stat-growth positive">
              <i data-lucide="trending-up"></i>
              <span class="growth-value" id="order-growth">0%</span>
              <span class="growth-text">from last month</span>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-info">
                <p class="stat-label">Total Sales</p>
                <h3 class="stat-value" id="total-sales">--</h3>
              </div>
              <div class="stat-icon green-icon">
                <i data-lucide="dollar-sign"></i>
              </div>
            </div>
            <div class="stat-growth negative">
              <i data-lucide="trending-down"></i>
              <span class="growth-value" id="sales-growth">0%</span>
              <span class="growth-text"> from last month</span>
            </div>
          </div>
        </div>


        <!-- Sales Chart -->
        <div class="chart-container">
          <div class="chart-header">
            <h3>Sales Details</h3>
            <select id="monthSelect" class="month-select">
              <option>January</option>
              <option>February</option>
              <option>March</option>
              <option>April</option>
              <option>May</option>
              <option>June</option>
              <option>July</option>
              <option>August</option>
              <option>September</option>
              <option>October</option>
              <option>November</option>
              <option>December</option>
            </select>
            <script>
              // Set default month to current month
              const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
              const recentMonth = months[new Date().getMonth()];
              document.getElementById('monthSelect').value = recentMonth;
            </script>
          </div>

          <div class="chart-wrapper">
            <canvas id="salesChart"></canvas>
          </div>

        </div>
    </div>
    </main>
  </div>
  </div>
  <script>
    async function initDashboard() {
      console.log('ðŸš€ Initializing Dashboard...');

      // Äáº£m báº£o DataManager tá»“n táº¡i
      if (!window.DataManager) {
        console.error('âŒ DataManager not found! Check script import order.');
        return;
      }

      // 1ï¸âƒ£ Kiá»ƒm tra náº¿u data chÆ°a Ä‘Æ°á»£c load
      if (!DataManager.isDataLoaded()) {
        console.log('ðŸ“¦ Data not loaded yet â†’ Loading all JSON data...');
        const success = await DataManager.loadAllData();
        if (!success) {
          alert('âŒ Failed to load data from JSON files. Please check console.');
          return;
        }
      } else {
        console.log('âœ… Data already cached in localStorage');
      }

      // 2ï¸âƒ£ Láº¥y dá»¯ liá»‡u sau khi load
      const accounts = DataManager.getAccounts();
      const products = DataManager.getProducts();
      const orders = DataManager.getOrders();
      const blogs = DataManager.getBlogs();
      const promotions = DataManager.getPromotions();

      console.log('ðŸ“Š Loaded datasets:', {
        accounts: accounts?.length,
        products: products?.length,
        orders: orders?.length,
        blogs: blogs?.length,
        promotions: promotions?.length,
      });

      // 3ï¸âƒ£ Render dashboard UI
      renderDashboardStats({ accounts, products, orders });
      initCharts({ orders });

      // 4ï¸âƒ£ Render icons (Lucide)
      if (typeof lucide !== "undefined" && lucide.createIcons) {
        lucide.createIcons();
      }

      console.log('âœ… Dashboard ready!');
    }

    /**
     * Render thá»‘ng kÃª tá»•ng quan
     */
    function renderDashboardStats({ accounts, products, orders }) {
      const userCountEl = document.getElementById('total-user');
      const orderCountEl = document.getElementById('total-order');
      const salesEl = document.getElementById('total-sales');

      if (userCountEl) userCountEl.textContent = accounts.length.toLocaleString();
      if (orderCountEl) orderCountEl.textContent = orders.length.toLocaleString();
      if (salesEl) salesEl.textContent = "$" + orders
        .filter(o => o.status === "Completed")
        .reduce((sum, o) => sum + (o.total_amount || 0), 0)
        .toLocaleString();
    }


    /**
     * Render biá»ƒu Ä‘á»“
     */
    function initCharts({ orders }) {
      if (typeof Chart === "undefined") {
        console.warn("âš ï¸ Chart.js not loaded. Skipping chart rendering.");
        return;
      }

      const ctx = document.getElementById("orderChart");
      if (!ctx) return;

      const months = Array.from({ length: 12 }, (_, i) => i + 1);
      const orderCounts = months.map((m) =>
        orders.filter((o) => new Date(o.order_date).getMonth() + 1 === m).length
      );

      new Chart(ctx, {
        type: "bar",
        data: {
          labels: months.map((m) => `ThÃ¡ng ${m}`),
          datasets: [
            {
              label: "Sá»‘ Ä‘Æ¡n hÃ ng",
              data: orderCounts,
            },
          ],
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            title: { display: true, text: "Thá»‘ng kÃª Ä‘Æ¡n hÃ ng theo thÃ¡ng" },
          },
        },
      });
    }

    window.addEventListener("DOMContentLoaded", initDashboard);
  </script>
  <script>
    // âœ… LOAD DASHBOARD DATA Tá»ª DATAMANAGER
    async function loadDashboardData() {
      try {
        console.log('ðŸ“Š Loading dashboard data from DataManager...');

        // Láº¥y dá»¯ liá»‡u tá»« DataManager
        const profiles = window.DataManager.getData('accounts');
        const ordersData = window.DataManager.getData('orders');

        if (!profiles || !ordersData) {
          console.error('âŒ Required data not found');
          return;
        }

        const orders = ordersData.orders;
        const thisMonth = new Date().getMonth();

        // TÃ­nh toÃ¡n dá»¯ liá»‡u cÆ¡ báº£n
        const totalUsers = profiles.profile ? profiles.profile.length : 0;
        const totalOrders = orders.filter(order => new Date(order.order_date).getMonth() === thisMonth).length;

        console.log('âœ… Dashboard stats calculated');
        console.log(`- Total users: ${totalUsers}`);
        console.log(`- Orders this month: ${totalOrders}`);

        // Cáº­p nháº­t vÃ o giao diá»‡n
        document.getElementById("total-user").textContent = totalUsers.toLocaleString();
        document.getElementById("total-order").textContent = totalOrders.toLocaleString();

        // TÃ­nh growth sá»‘ Ä‘Æ¡n hÃ ng theo thÃ¡ng
        if (typeof applyMonthlyGrowth === "function") {
          applyMonthlyGrowth(
            "order",
            orders,
            "order_date",
            order => order.status === "Completed"
          );
        }

        // TÃ­nh growth doanh thu theo thÃ¡ng
        const completedOrders = orders.filter(o => o.status === "Completed");

        const now = new Date();
        const currentMonth = now.getMonth();
        const previousMonth = currentMonth === 0 ? 11 : currentMonth - 1;
        const currentYear = now.getFullYear();

        // Tá»•ng doanh thu thÃ¡ng hiá»‡n táº¡i
        const currentSales = completedOrders
          .filter(o => {
            const d = new Date(o.order_date);
            return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
          })
          .reduce((sum, o) => sum + o.items.reduce((acc, i) => acc + i.quantity * i.unit_price, 0), 0);

        // Tá»•ng doanh thu thÃ¡ng trÆ°á»›c
        const previousSales = completedOrders
          .filter(o => {
            const d = new Date(o.order_date);
            const prevYear = previousMonth === 11 ? currentYear - 1 : currentYear;
            return d.getMonth() === previousMonth && d.getFullYear() === prevYear;
          })
          .reduce((sum, o) => sum + o.items.reduce((acc, i) => acc + i.quantity * i.unit_price, 0), 0);

        // Hiá»ƒn thá»‹ tá»•ng doanh thu
        document.getElementById("total-sales").textContent = "$" + currentSales.toLocaleString();

        console.log(`âœ… Current month revenue: $${currentSales.toLocaleString()}`);
        console.log(`âœ… Previous month revenue: $${previousSales.toLocaleString()}`);

        // Chuáº©n bá»‹ máº£ng dá»¯ liá»‡u cho applyMonthlyGrowth
        const salesData = [
          { value: currentSales, month: currentMonth },
          { value: previousSales, month: previousMonth }
        ];

        // Gá»i hÃ m cáº­p nháº­t growth cho doanh thu
        if (typeof applyMonthlyGrowth === "function") {
          applyMonthlyGrowth("sales", salesData, "value");
        }

        console.log('âœ… Dashboard data loaded successfully');

      } catch (error) {
        console.error("âŒ Error loading dashboard data:", error);
      }
    }

    // âœ… LOAD VÃ€ RENDER SALES CHART Tá»ª DATAMANAGER
    const ctx = document.getElementById('salesChart').getContext('2d');
    const monthSelect = document.getElementById('monthSelect');
    let salesChart;
    let currentMonth = monthSelect.value;

    // HÃ m load vÃ  tÃ­nh tá»•ng doanh thu theo tuáº§n trong thÃ¡ng
    async function loadMonthlySales(monthName) {
      console.log(`ðŸ“ˆ Loading sales data for ${monthName}...`);

      // Láº¥y dá»¯ liá»‡u tá»« DataManager
      const ordersData = window.DataManager.getData('orders');
      if (!ordersData) {
        console.error('âŒ Orders data not found');
        return [0, 0, 0, 0];
      }

      const orders = ordersData.orders;

      // Táº¡o map thÃ¡ng â†’ sá»‘ (Ä‘á»ƒ lá»c dá»¯ liá»‡u theo order_date)
      const monthMap = {
        January: 1, February: 2, March: 3, April: 4,
        May: 5, June: 6, July: 7, August: 8,
        September: 9, October: 10, November: 11, December: 12
      };

      const selectedMonth = monthMap[monthName];
      const currentYear = new Date().getFullYear();

      // Lá»c cÃ¡c Ä‘Æ¡n hÃ ng cá»§a thÃ¡ng Ä‘Ã£ chá»n
      const filteredOrders = orders.filter(o => {
        const d = new Date(o.order_date);
        return d.getMonth() + 1 === selectedMonth && d.getFullYear() === currentYear;
      });

      console.log(`âœ… Found ${filteredOrders.length} orders for ${monthName}`);

      // Chia doanh thu theo tuáº§n trong thÃ¡ng
      const weeklyRevenue = [0, 0, 0, 0];
      filteredOrders.forEach(o => {
        const day = new Date(o.order_date).getDate();
        const weekIndex = Math.min(Math.floor((day - 1) / 7), 3);
        if (o.status === "Completed") {
          weeklyRevenue[weekIndex] += o.total_amount;
        }
      });

      console.log('âœ… Weekly revenue calculated:', weeklyRevenue);
      return weeklyRevenue;
    }

    // HÃ m táº¡o chart
    function createChart(month, weeklyRevenue) {
      return new Chart(ctx, {
        type: 'line',
        data: {
          labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
          datasets: [{
            label: `Revenue in ${month}`,
            data: weeklyRevenue,
            borderColor: 'rgba(61,165,71,100)',
            backgroundColor: 'rgba(61,165,71,0.1)',
            fill: true,
            tension: 0.4,
            pointRadius: 5,
            pointHoverRadius: 7,
            pointBackgroundColor: 'rgba(61,165,71,100)'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              mode: 'index',
              intersect: false,
              callbacks: {
                label: context => 'Revenue: $' + context.parsed.y.toLocaleString()
              }
            }
          },
          scales: {
            x: { grid: { display: false } },
            y: {
              grid: { color: 'rgba(200,200,200,0.1)' },
              ticks: { callback: value => '$' + value.toLocaleString() }
            }
          }
        }
      });
    }

    // Khá»Ÿi táº¡o chart máº·c Ä‘á»‹nh theo thÃ¡ng Ä‘ang chá»n
    async function initChart() {
      console.log('ðŸ“Š Initializing sales chart...');
      const monthlyRevenue = await loadMonthlySales(currentMonth);
      salesChart = createChart(currentMonth, monthlyRevenue);
      console.log('âœ… Sales chart initialized');
    }

    // Chá»‰ cáº­p nháº­t khi chá»n thÃ¡ng má»›i
    monthSelect.addEventListener('change', async () => {
      const newMonth = monthSelect.value;
      if (newMonth !== currentMonth) {
        console.log(`ðŸ”„ Changing chart to ${newMonth}...`);
        currentMonth = newMonth;
        const monthlyRevenue = await loadMonthlySales(newMonth);
        salesChart.destroy();
        salesChart = createChart(newMonth, monthlyRevenue);
        console.log('âœ… Chart updated');
      }
    });

    // âœ… INITIALIZATION
    window.addEventListener('DOMContentLoaded', () => {
      console.log('ðŸš€ Initializing dashboard...');
      checkAuthentication();
      // Load dashboard data
      loadDashboardData();

      // Initialize chart
      initChart();

      // Initialize Lucide icons
      if (typeof lucide !== "undefined" && lucide.createIcons) {
        lucide.createIcons();
      }

      console.log('âœ… Dashboard initialized');
    });
  </script>
</body>
</html>