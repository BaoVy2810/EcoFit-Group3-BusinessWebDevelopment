<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>Payment</title>
  <link rel="icon" href="../images/ecofit_logo2.png" sizes="32x32" type="image/png">

  <link rel="stylesheet" href="../css/USER_MAINSTYLE.css" />
  <script src="../js/notification_handler.js"></script>
</head>

<body class="bodypayment">
  <iframe id="header-frame" class="header-frame"></iframe>
  <script>
    window.addEventListener("DOMContentLoaded", () => {
      const header = document.getElementById("header-frame");
      const isLoggedIn = localStorage.getItem("isLoggedIn") === "true";
      header.src = isLoggedIn
        ? "../template/header.html"
        : "../template/header0.html";

      header.onload = () => {
        header.contentWindow.postMessage({ activeNav: "nav-shop" }, "*");
      };

      // Load order data from localStorage
      loadOrderData();
    });

    // Function to load order data from localStorage
    function loadOrderData() {
      // Get order data from localStorage
      const orderData = JSON.parse(localStorage.getItem("orderData") || "{}");
      const cart = JSON.parse(localStorage.getItem("cart") || "[]");
      
      // Calculate order summary
      let subtotal = 0;
      cart.forEach(item => {
        subtotal += item.price * item.quantity;
      });
      
      const shipping = 30000; // Fixed shipping cost
      const discount = orderData.discount || 0;
      const total = subtotal + shipping - discount;
      
      // Update Order Detail section
      const orderDetailContainer = document.querySelector('.order-detail');
      orderDetailContainer.innerHTML = '<h3 class="order-detail__title">ORDER DETAIL</h3>';
      
      if (cart.length === 0) {
        orderDetailContainer.innerHTML += '<p class="empty-cart">No items in cart</p>';
      } else {
        cart.forEach(item => {
          const itemElement = document.createElement('div');
          itemElement.className = 'order-detail-item';
          itemElement.innerHTML = `
            <div class="order-detail-item__info">
              <div class="order-detail-item__name">${item.name}</div>
              <div class="order-detail-item__price">${formatPrice(item.price)}đ x ${item.quantity}</div>
            </div>
            <div class="order-detail-item__total">${formatPrice(item.price * item.quantity)}đ</div>
          `;
          orderDetailContainer.appendChild(itemElement);
        });
      }
      
      // Update Order Summary section
      document.querySelector('.subtotal').textContent = formatPrice(subtotal) + 'đ';
      document.querySelector('.shipping').textContent = formatPrice(shipping) + 'đ';
      document.querySelector('.discount').textContent = formatPrice(discount) + 'đ';
      document.querySelector('.total-value').textContent = formatPrice(total) + 'đ';
      
      // Update Payment Detail section
      document.querySelectorAll('.pd-value')[0].textContent = formatPrice(total) + 'đ';
      document.querySelectorAll('.pd-value')[1].textContent = formatPrice(total) + 'đ';
      
      // Update Transfer Amount
      document.getElementById('amt').textContent = formatPrice(total) + 'đ';
      
      // Update Order ID in multiple places
      const orderId = orderData.orderId || '1056';
      document.querySelector('.status-sub').textContent = `Order #${orderId}`;
      document.getElementById('note').textContent = `ORDER_${orderId}`;
      
      // Update Delivery Address
      const deliveryAddress = orderData.deliveryAddress || '- | -<br>-';
      document.querySelector('.delivery-text').innerHTML = deliveryAddress;
    }
    
    // Helper function to format price
    function formatPrice(price) {
      return price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    // 🔹 BỔ SUNG ĐOẠN NÀY ĐỂ NHẬN TÍN HIỆU TỪ HEADER VÀ XỬ LÝ LOGIN/LOGOUT
    window.addEventListener("message", (e) => {
      if (!e.data || !e.data.action) return;

      // Bấm nút Login trong header0
      if (e.data.action === "goToLogin") {
        window.location.href = "00_LOGIN.html";
      }

      // Bấm nút Sign Up trong header0
      if (e.data.action === "goToSignup") {
        window.location.href = "00_SIGNUP.html";
      }

      // Khi đăng nhập thành công (từ login.js hoặc login form)
      if (e.data.action === "loginSuccess" || e.data.action === "loggedIn") {
        localStorage.setItem("isLoggedIn", "true");
        document.getElementById("header-frame").src = "../template/header.html";
      }

      // Khi người dùng logout từ header.html
      if (e.data.action === "logout") {
        localStorage.removeItem("isLoggedIn");
        localStorage.removeItem("login_infor");
        document.getElementById("header-frame").src = "../template/header0.html";
      }
      // 🟢 Xử lý toggle notifications
      if (e.data.action === "toggleNotifications") {
          if (!window.NotificationPopup) {
              window.NotificationPopup = createNotificationPopupInParent(
                  e.data.notifications, 
                  e.data.bellPosition
              );
          } else {
              window.NotificationPopup.toggle();
          }
      }
    });
    
    document.querySelectorAll('.copy').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.getAttribute('data-target');
        const text = document.getElementById(id).textContent.trim();

        if (navigator.clipboard) {
          navigator.clipboard.writeText(text).then(() => {
            // Hiện dấu check
            btn.innerHTML = '✓';
            // Đổi lại icon copy sau 900ms
            setTimeout(() => {
              btn.innerHTML = '<img src="../images/ic_copy.png" />';
            }, 900);
          }).catch(() => {
            alert('Copy failed');
          });
        } else {
          alert('Copy not supported');
        }
      });
    });
  </script>
  <main class="checkout-container">
    <!-- LEFT -->
    <section class="checkout-left">
      <h2 class="page-title">PAYMENT</h2>
      <div class="status-box">
        <div class="status-icon">
          <img src="../images/ic_payment.png" />
        </div>
        <div class="status-text">
          <div class="status-title">Awaiting Payment</div>
          <div class="status-sub">Order #1056</div>
        </div>
      </div>
      <!--BIG PAYMENT BOX-->
      <div class="payment-box">
        <!-- Payment Detail -->
        <div class="section payment-detail">
          <h2 class="title">Payment Detail</h2>
          <div class="pd-list">
            <div class="pd-row">
              <div class="pd-label">Total order amount</div>
              <div class="pd-value">165.000</div>
            </div>
            <div class="pd-row">
              <div class="pd-label">Amount due</div>
              <div class="pd-value">165.000</div>
            </div>
            <div class="pd-row">
              <div class="pd-label">Payment method</div>
              <div class="pd-value small">Transfer via QR code</div>
            </div>
          </div>
          <div class="pay-wrap">
            <button class="btn-pay">PAY NOW →</button>
          </div>
        </div>
        <div class="divider"></div>
        <!-- Transfer Description + QR -->
        <div class="section transfer-section">
          <div class="transfer-left">
            <div class="transfer-card">
              <div class="transfer-title">Transfer Description</div>
              <div class="tr-row">
                <div class="tr-label">Account</div>
                <div class="tr-value">ECOFIT</div>
              </div>
              <div class="tr-row">
                <div class="tr-label">Receiving Bank</div>
                <div class="tr-value">Vietcombank</div>
              </div>
              <div class="tr-row">
                <div class="tr-label">Account Number</div>
                <div class="tr-value">
                  <span id="acc">0339667803</span>
                  <button class="copy" data-target="acc" title="Copy">
                    <img src="../images/ic_copy.png" />
                  </button>
                </div>
              </div>
              <div class="tr-row">
                <div class="tr-label">Transfer Note</div>
                <div class="tr-value">
                  <span id="note">ORDER_1056</span>
                  <button class="copy" data-target="note" title="Copy">
                    <img src="../images/ic_copy.png" />
                  </button>
                </div>
              </div>
              <div class="tr-row last">
                <div class="tr-label">Transfer Amount</div>
                <div class="tr-value">
                  <strong id="amt">165.000</strong>
                  <button class="copy" data-target="amt" title="Copy">
                    <img src="../images/ic_copy.png" />
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div class="transfer-right">
            <div class="qr-card">
              <img src="https://api.qrserver.com/v1/create-qr-code/?data=EcoFitPayment&size=160x160" alt="QR Code"
                style="width:140px;height:140px;object-fit:cover;border-radius:6px">
              <img src="../images/Logo-Napas.jpg" width="70px" style="margin-top: 8px;" />
            </div>
          </div>
        </div>
        <div class="divider"></div>
        <!-- Proof of Transfer -->
        <h2 class="title">Proof of Transfer</h2>
        <div class="section proof-section">
          <p class="proof-text">Kindly upload your proof to transfer to help us verify your payment faster</p>
          <div class="proof-action">
            <label class="upload-btn">
              <img src="../images/ic_upload.png" width="15px" height="15px" /> Upload
              <input type="file" hidden id="proofImage">
            </label>
            <span id="fileName" style="margin-left:10px; margin-top: 15px; font-size:13px; color:#555;"></span>
          </div>
        </div>
      </div>
      <!-- DELIVERY BOX (separate) -->
      <div class="delivery-box">
        <h2 class="title">Delivery address</h2>
        <p class="delivery-text">
          - | - <br>
          -
        </p>
      </div>
    </section>
    <!-- RIGHT -->
    <div class="checkout-right">
      <!-- ORDER DETAIL -->
      <div class="order-detail">
        <h3 class="order-detail__title">ORDER DETAIL</h3>
        <!-- Sản phẩm sẽ được load động từ JavaScript -->
      </div>
      
      <br/>
      <!-- ORDER SUMMARY -->
      <div class="order-summary">
        <h2 class="order-summary__title">ORDER SUMMARY</h2>
        
        <div class="order-summary__row">
          <span>Subtotal Product</span>
          <span class="order-summary__value subtotal">-</span>
        </div>
        
        <div class="order-summary__row">
          <span>Shipping Cost</span>
          <span class="order-summary__value shipping">30.000đ</span>
        </div>
        
        <div class="order-summary__row">
          <span>Discount</span>
          <span class="order-summary__value discount">-</span>
        </div>
        
        <div class="order-summary__total">
          <span>Total</span>
          <span class="total-value">-</span>
        </div>
      </div>
    </div>
  </main>
  <iframe src="../template/footer.html" id="footer-frame" class="footer-frame"></iframe>
  <script src="../js/payment1.js"></script>
</body>
</html>